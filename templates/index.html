<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APEX TRADE â€” AI Signal Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ THEME VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:#040b14; --bg2:#071220;
  --glass:rgba(0,212,255,0.04); --glass-border:rgba(0,212,255,0.15);
  --primary:#00d4ff; --primary2:#7b61ff; --accent:#00ff9d;
  --warn:#ff6b35; --sell:#ff3d71; --buy:#00e5a0;
  --text:#e8f4f8; --muted:#4a7a96; --card-bg:rgba(5,18,32,0.92);
  --header-bg:rgba(4,11,20,0.93);
  --rank1:rgba(255,215,0,0.08); --rank1b:rgba(255,215,0,0.35);
  --rank2:rgba(192,192,192,0.06); --rank2b:rgba(192,192,192,0.3);
  --rank3:rgba(205,127,50,0.06); --rank3b:rgba(205,127,50,0.3);
}
:root[data-theme="light"] {
  --bg:#eef2f7; --bg2:#e2eaf2;
  --glass:rgba(0,100,180,0.05); --glass-border:rgba(0,100,180,0.18);
  --primary:#0066cc; --primary2:#5530cc; --accent:#009955;
  --warn:#d94f00; --sell:#cc1133; --buy:#007744;
  --text:#0d1f2d; --muted:#5a7a96; --card-bg:rgba(255,255,255,0.93);
  --header-bg:rgba(238,242,247,0.95);
  --rank1:rgba(255,180,0,0.1); --rank1b:rgba(200,150,0,0.5);
  --rank2:rgba(100,100,120,0.08); --rank2b:rgba(100,100,120,0.4);
  --rank3:rgba(140,80,20,0.07); --rank3b:rgba(140,80,20,0.4);
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* grid bg */
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(0,212,255,0.025) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,212,255,0.025) 1px,transparent 1px);
  background-size:44px 44px;pointer-events:none}
[data-theme="light"] body::before{
  background-image:linear-gradient(rgba(0,80,160,0.05) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,80,160,0.05) 1px,transparent 1px)}

.container{max-width:1480px;margin:0 auto;padding:0 22px;position:relative;z-index:1}

/* â”€â”€ HEADER â”€â”€ */
header{position:sticky;top:0;z-index:100;background:var(--header-bg);
  backdrop-filter:blur(28px);border-bottom:1px solid var(--glass-border);padding:13px 0}
.header-inner{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.logo{font-size:1.55rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--primary2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-1.5px}
.logo em{-webkit-text-fill-color:var(--accent);font-style:normal}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.session-pill{padding:4px 11px;border-radius:20px;font-size:.68rem;font-weight:700;
  font-family:'Space Mono',monospace;background:var(--glass);border:1px solid var(--glass-border);
  color:var(--accent);text-transform:uppercase;letter-spacing:.5px}
.utc-clock{font-family:'Space Mono',monospace;font-size:.78rem;color:var(--primary);letter-spacing:2px}
.theme-btn{background:var(--glass);border:1px solid var(--glass-border);color:var(--text);
  padding:5px 14px;border-radius:20px;cursor:pointer;font-size:.78rem;font-family:'Syne',sans-serif;transition:all .2s}
.theme-btn:hover{border-color:var(--primary);color:var(--primary)}

/* â”€â”€ TICKER â”€â”€ */
.ticker-wrap{overflow:hidden;border-bottom:1px solid var(--glass-border);padding:7px 0;background:var(--glass)}
.ticker-inner{display:flex;gap:36px;animation:ticker 50s linear infinite;width:max-content}
@keyframes ticker{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.tick-item{display:flex;align-items:center;gap:8px;white-space:nowrap;font-size:.76rem}
.tick-sym{font-weight:800;font-family:'Space Mono',monospace;color:var(--primary)}
.tick-px{font-family:'Space Mono',monospace;color:var(--text)}
.tick-ch.up{color:var(--buy)} .tick-ch.dn{color:var(--sell)}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:4px;padding:22px 0 0}
.tab{padding:10px 26px;border-radius:8px 8px 0 0;background:var(--glass);
  border:1px solid var(--glass-border);border-bottom:none;color:var(--muted);
  cursor:pointer;font-size:.84rem;font-weight:700;transition:all .2s;user-select:none}
.tab.active{background:var(--card-bg);color:var(--primary);border-color:var(--primary)}
.tab:hover:not(.active){color:var(--text)}
.tab-content{display:none}
.tab-content.active{display:block}

/* â”€â”€ PANEL â”€â”€ */
.panel{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:0 18px 18px 18px;
  padding:26px;margin-bottom:26px;backdrop-filter:blur(22px)}

/* â”€â”€ CONTROLS â”€â”€ */
.ctrl-row{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-end}
.ctrl-group{display:flex;flex-direction:column;gap:7px}
.ctrl-label{font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:700}
.seg-grp{display:flex;gap:4px}
.seg{padding:8px 18px;border-radius:9px;border:1px solid var(--glass-border);background:var(--glass);
  color:var(--muted);cursor:pointer;font-size:.82rem;font-weight:700;font-family:'Syne',sans-serif;transition:all .2s}
.seg.on{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;border-color:transparent;
  box-shadow:0 0 18px rgba(0,212,255,0.2)}
.seg:hover:not(.on){border-color:var(--primary);color:var(--primary)}

.dur-wrap{display:flex;gap:8px;align-items:center}
.dur-inp{width:88px;padding:8px 12px;border-radius:9px;background:var(--glass);
  border:1px solid var(--glass-border);color:var(--text);font-family:'Space Mono',monospace;
  font-size:.84rem;text-align:center}
.dur-inp:focus{outline:none;border-color:var(--primary)}
.dur-unit{font-size:.72rem;color:var(--muted)}

/* Generate button */
.gen-btn{position:relative;overflow:hidden;padding:13px 38px;border-radius:12px;border:none;
  background:linear-gradient(135deg,var(--primary) 0%,var(--primary2) 100%);
  color:#fff;font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;
  letter-spacing:.5px;box-shadow:0 0 36px rgba(0,212,255,0.25);transition:all .25s}
.gen-btn:hover{transform:translateY(-2px);box-shadow:0 0 56px rgba(0,212,255,0.4)}
.gen-btn:active{transform:translateY(0)}
.gen-btn.busy{pointer-events:none;opacity:.72}
.gen-btn::after{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.18),transparent);opacity:0;transition:.2s}
.gen-btn:hover::after{opacity:1}

/* â”€â”€ STATS ROW â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(165px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:16px;
  padding:18px 20px;backdrop-filter:blur(16px)}
.stat-lbl{font-size:.67rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;font-weight:700}
.stat-val{font-size:1.75rem;font-weight:800;font-family:'Space Mono',monospace;color:var(--primary)}
.stat-sub{font-size:.7rem;color:var(--muted);margin-top:3px}

/* â”€â”€ SECTION TITLE â”€â”€ */
.sec-title{font-size:.82rem;font-weight:800;color:var(--primary);text-transform:uppercase;
  letter-spacing:2px;margin-bottom:16px;padding-bottom:9px;border-bottom:1px solid var(--glass-border)}

/* â”€â”€ TOP-3 WRAPPER â”€â”€ */
.top3-label{font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;
  letter-spacing:2px;margin-bottom:14px;display:flex;align-items:center;gap:10px}
.top3-label::after{content:'';flex:1;height:1px;background:var(--glass-border)}

.top3-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(440px,1fr));gap:20px;margin-bottom:30px}
@media(max-width:900px){.top3-grid{grid-template-columns:1fr}}

/* â”€â”€ RANK CARD â”€â”€ */
.rank-card{border-radius:20px;padding:24px;backdrop-filter:blur(22px);
  position:relative;overflow:hidden;animation:slideIn .4s ease both}
.rank-card:nth-child(2){animation-delay:.08s}
.rank-card:nth-child(3){animation-delay:.16s}
@keyframes slideIn{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}

.rank-card.r1{background:var(--rank1);border:1px solid var(--rank1b)}
.rank-card.r2{background:var(--rank2);border:1px solid var(--rank2b)}
.rank-card.r3{background:var(--rank3);border:1px solid var(--rank3b)}

/* top glow bar */
.rank-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.rank-card.r1::before{background:linear-gradient(90deg,#ffd700,#ffaa00)}
.rank-card.r2::before{background:linear-gradient(90deg,#c0c0c0,#a0a0b0)}
.rank-card.r3::before{background:linear-gradient(90deg,#cd7f32,#a05a1a)}
.rank-card.LONG::before{background:linear-gradient(90deg,var(--buy),#00c8ff)!important}
.rank-card.SHORT::before{background:linear-gradient(90deg,var(--sell),#ff9900)!important}

/* rank medal */
.medal{position:absolute;top:16px;right:18px;font-size:2rem;line-height:1;opacity:.9;filter:drop-shadow(0 2px 8px rgba(0,0,0,.4))}

/* card header */
.card-hdr{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:18px}
.asset-name{font-size:2rem;font-weight:800;letter-spacing:-1px;line-height:1}
.asset-sub{font-size:.72rem;color:var(--muted);margin-top:3px}
.badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:6px}
.badge{padding:4px 11px;border-radius:20px;font-size:.66rem;font-weight:700;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.5px}
.b-long{background:rgba(0,229,160,.12);color:var(--buy);border:1px solid rgba(0,229,160,.3)}
.b-short{background:rgba(255,61,113,.12);color:var(--sell);border:1px solid rgba(255,61,113,.3)}
.b-info{background:var(--glass);color:var(--primary);border:1px solid var(--glass-border)}
.b-safe{background:rgba(0,229,160,.08);color:var(--accent);border:1px solid rgba(0,229,160,.2)}
.b-warn{background:rgba(255,107,53,.1);color:var(--warn);border:1px solid rgba(255,107,53,.25)}

/* metrics grid */
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0}
@media(max-width:560px){.metrics{grid-template-columns:repeat(2,1fr)}}
.metric{background:var(--glass);border:1px solid var(--glass-border);border-radius:11px;padding:12px}
.m-lbl{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;font-weight:700}
.m-val{font-size:1.05rem;font-weight:800;font-family:'Space Mono',monospace}
.m-val.buy{color:var(--buy)} .m-val.sell{color:var(--sell)} .m-val.pri{color:var(--primary)}
.m-val.warn{color:var(--warn)}
.m-sub{font-size:.62rem;color:var(--muted);margin-top:2px}

/* confidence */
.conf-wrap{margin:14px 0}
.conf-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.conf-lbl{font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;font-weight:700}
.conf-pct{font-size:.88rem;font-weight:800;font-family:'Space Mono',monospace;color:var(--accent)}
.conf-bar{height:7px;border-radius:10px;background:var(--glass);overflow:hidden}
.conf-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .9s ease}

/* indicators */
.ind-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:14px 0}
@media(max-width:560px){.ind-grid{grid-template-columns:1fr}}
.ind-row{display:flex;align-items:center;gap:9px;padding:9px 12px;
  border-radius:9px;background:var(--glass);border:1px solid var(--glass-border)}
.ind-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);flex-shrink:0}
.ind-info{flex:1;min-width:0}
.ind-name{font-size:.7rem;font-weight:700}
.ind-sig{font-size:.62rem;color:var(--muted);margin-top:1px}
.ind-val{font-size:.7rem;color:var(--primary);font-family:'Space Mono',monospace;flex-shrink:0;text-align:right}

/* reasoning */
.reason{background:var(--glass);border:1px solid var(--glass-border);
  border-radius:11px;padding:13px;margin-top:13px}
.reason h4{font-size:.68rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;font-weight:700}
.reason p{font-size:.8rem;color:var(--muted);line-height:1.75}

/* timer */
.timer-sec{margin-top:14px}
.timer-lbl{font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;font-weight:700}
.timer-disp{font-family:'Space Mono',monospace;font-size:1.3rem;color:var(--warn);letter-spacing:3px}
.timer-bar{height:4px;border-radius:10px;background:var(--glass);margin-top:7px;overflow:hidden}
.timer-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--warn));transition:width 1s linear}
.close-btn{margin-top:14px;padding:7px 18px;border-radius:8px;background:rgba(255,61,113,.1);
  border:1px solid rgba(255,61,113,.35);color:var(--sell);cursor:pointer;
  font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;transition:all .2s}
.close-btn:hover{background:rgba(255,61,113,.22)}

/* placeholder */
.placeholder{text-align:center;padding:70px 20px;color:var(--muted)}
.placeholder .ico{font-size:3.5rem;margin-bottom:18px;opacity:.35}
.placeholder strong{color:var(--text)}
.placeholder p{margin-top:8px;font-size:.8rem}

/* â”€â”€ HEATMAP â”€â”€ */
.heatmap-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px}
.heat-cell{border-radius:11px;padding:14px 8px;text-align:center;cursor:pointer;
  transition:transform .15s,box-shadow .15s;border:1px solid transparent}
.heat-cell:hover{transform:scale(1.06);box-shadow:0 8px 24px rgba(0,0,0,.3);border-color:rgba(255,255,255,.15)}
.heat-sym{font-weight:800;font-size:.88rem;font-family:'Space Mono',monospace;color:#fff}
.heat-chg{font-size:.74rem;margin-top:4px;font-weight:700}
.heat-px{font-size:.63rem;color:rgba(255,255,255,.65);margin-top:2px}

/* â”€â”€ HISTORY TABLE â”€â”€ */
.hist-table{width:100%;border-collapse:collapse}
.hist-table th{text-align:left;padding:9px 13px;font-size:.66rem;text-transform:uppercase;
  letter-spacing:1px;color:var(--muted);border-bottom:1px solid var(--glass-border);font-weight:700}
.hist-table td{padding:11px 13px;font-size:.8rem;border-bottom:1px solid rgba(255,255,255,.03)}
.hist-table tr:hover td{background:var(--glass)}
.rank-badge{display:inline-block;width:22px;height:22px;border-radius:50%;
  font-size:.72rem;font-weight:800;text-align:center;line-height:22px}
.rank-badge.r1{background:rgba(255,215,0,.2);color:#ffd700}
.rank-badge.r2{background:rgba(192,192,192,.18);color:#c0c0c0}
.rank-badge.r3{background:rgba(205,127,50,.18);color:#cd7f32}

/* â”€â”€ ALERTS â”€â”€ */
.notif-prefs{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:16px;padding:20px;margin-bottom:20px}
.tog-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass-border)}
.tog-row:last-child{border-bottom:none}
.tog-lbl{font-size:.84rem;font-weight:600}
.tog-sub{font-size:.7rem;color:var(--muted);margin-top:2px}
.toggle{position:relative;width:44px;height:24px}
.toggle input{opacity:0;width:0;height:0}
.tog-slider{position:absolute;inset:0;border-radius:12px;background:var(--glass);
  border:1px solid var(--glass-border);cursor:pointer;transition:.28s}
.tog-slider::before{content:'';position:absolute;height:18px;width:18px;left:2px;bottom:2px;
  border-radius:50%;background:var(--muted);transition:.28s}
.toggle input:checked+.tog-slider{background:rgba(0,229,160,.18);border-color:var(--accent)}
.toggle input:checked+.tog-slider::before{transform:translateX(20px);background:var(--accent)}

/* â”€â”€ TOAST PANEL â”€â”€ */
.toast-panel{position:fixed;bottom:24px;right:24px;width:330px;z-index:200;display:flex;flex-direction:column;gap:9px}
.toast{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:14px;
  padding:13px 15px;backdrop-filter:blur(22px);animation:toastIn .3s ease;border-left:3px solid var(--accent)}
.toast.sell{border-left-color:var(--sell)}
.toast.warn{border-left-color:var(--warn)}
@keyframes toastIn{from{opacity:0;transform:translateX(56px)}to{opacity:1;transform:translateX(0)}}
.toast-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}
.toast-title{font-size:.78rem;font-weight:700}
.toast-x{cursor:pointer;color:var(--muted);font-size:.95rem;padding:2px 4px}
.toast-body{font-size:.73rem;color:var(--muted);line-height:1.65;white-space:pre-line}

/* â”€â”€ SPINNER â”€â”€ */
.spin{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:7px}
@keyframes spin{to{transform:rotate(360deg)}}

/* scrollbar */
::-webkit-scrollbar{width:5px} ::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--glass-border);border-radius:10px}

/* GitHub guide box */
.guide-box{background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;padding:16px 20px;margin-bottom:16px}
.guide-box h3{font-size:.78rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:700}
.guide-box ol{padding-left:18px;display:flex;flex-direction:column;gap:6px}
.guide-box li{font-size:.82rem;color:var(--muted);line-height:1.6}
.guide-box code{font-family:'Space Mono',monospace;font-size:.78rem;
  background:var(--glass);border:1px solid var(--glass-border);
  padding:2px 7px;border-radius:5px;color:var(--primary)}

@media(max-width:640px){.ctrl-row{flex-direction:column}.gen-btn{width:100%}.asset-name{font-size:1.6rem}}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="container">
    <div class="header-inner">
      <div class="logo">APEX<em>TRADE</em></div>
      <div class="hdr-right">
        <span class="session-pill" id="sessionBadge">Loading...</span>
        <span class="utc-clock" id="utcClock">--:--:-- UTC</span>
        <button class="theme-btn" onclick="toggleTheme()">â˜€ / â˜¾ Theme</button>
      </div>
    </div>
  </div>
</header>

<!-- LIVE TICKER -->
<div class="ticker-wrap">
  <div class="ticker-inner" id="tickerInner">
    <span class="tick-item"><span class="tick-sym">APEX</span><span class="tick-px">Fetching live pricesâ€¦</span></span>
  </div>
</div>

<div class="container" style="padding-top:20px;padding-bottom:70px">

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('signals')">âš¡ Signals</div>
    <div class="tab" onclick="switchTab('heatmap')">ðŸ”¥ Heatmap</div>
    <div class="tab" onclick="switchTab('history')">ðŸ“‹ History</div>
    <div class="tab" onclick="switchTab('alerts')">ðŸ”” Alerts</div>
    <div class="tab" onclick="switchTab('deploy')">ðŸš€ Deploy Guide</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIGNALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content active" id="tab-signals">

    <!-- Controls -->
    <div class="panel">
      <div class="ctrl-row">
        <div class="ctrl-group">
          <div class="ctrl-label">Market</div>
          <div class="seg-grp" id="grpMarket">
            <button class="seg on" onclick="setSeg('grpMarket',this,'crypto')">Crypto</button>
            <button class="seg"    onclick="setSeg('grpMarket',this,'forex')">Forex</button>
          </div>
        </div>
        <div class="ctrl-group">
          <div class="ctrl-label">Trade Type</div>
          <div class="seg-grp" id="grpType">
            <button class="seg on" onclick="setSeg('grpType',this,'scalp')">Scalp</button>
            <button class="seg"    onclick="setSeg('grpType',this,'intraday')">Intraday</button>
            <button class="seg"    onclick="setSeg('grpType',this,'swing')">Swing</button>
          </div>
        </div>
        <div class="ctrl-group">
          <div class="ctrl-label">Duration</div>
          <div class="dur-wrap">
            <div class="seg-grp" id="grpDur">
              <button class="seg on" onclick="setDurMode('auto',this)">Auto</button>
              <button class="seg"    onclick="setDurMode('custom',this)">Custom</button>
            </div>
            <span id="customDurWrap" style="display:none;gap:7px;align-items:center;display:none">
              <input class="dur-inp" type="number" id="durInput" placeholder="60" min="1" max="10080">
              <span class="dur-unit">min</span>
            </span>
          </div>
        </div>
        <div class="ctrl-group">
          <div class="ctrl-label" style="visibility:hidden">.</div>
          <button class="gen-btn" id="genBtn" onclick="generateTrades()">âš¡ Generate Top 3 Trades</button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-lbl">Total Signals</div>
        <div class="stat-val" id="sTot">0</div>
        <div class="stat-sub">Generated this session</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">Open Trades</div>
        <div class="stat-val" id="sOpen">0</div>
        <div class="stat-sub">Active positions</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">Avg Confidence</div>
        <div class="stat-val" id="sConf">â€”</div>
        <div class="stat-sub">Across all signals</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">Avg Leverage</div>
        <div class="stat-val" id="sLev">â€”</div>
        <div class="stat-sub">Dynamic per signal</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">Best RR</div>
        <div class="stat-val" id="sRR">â€”</div>
        <div class="stat-sub">Risk:Reward ratio</div>
      </div>
    </div>

    <!-- Trade output -->
    <div id="tradeArea">
      <div class="placeholder">
        <div class="ico">âš¡</div>
        <div><strong>Ready to scan the market</strong></div>
        <p>Click <strong>Generate Top 3 Trades</strong> to receive the highest-probability signals.<br>
        The engine scans 6 candidates and ranks the top 3 by confidence score.</p>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEATMAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-heatmap">
    <div class="panel">
      <div class="sec-title">Crypto Market Heatmap â€” Live 24h Performance</div>
      <div class="heatmap-grid" id="heatmapGrid">
        <div style="color:var(--muted);font-size:.85rem;padding:20px">Loading heatmap dataâ€¦</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HISTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-history">
    <div class="panel">
      <div class="sec-title">Trade Signal History</div>
      <div style="overflow-x:auto">
        <table class="hist-table">
          <thead>
            <tr>
              <th>Rank</th><th>Asset</th><th>Type</th><th>Direction</th>
              <th>Entry</th><th>TP</th><th>SL</th><th>R:R</th>
              <th>Leverage</th><th>Duration</th><th>Confidence</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="histBody">
            <tr><td colspan="12" style="text-align:center;padding:40px;color:var(--muted);font-size:.85rem">No signals yet â€” generate your first trade!</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALERTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-alerts">
    <div class="panel">
      <div class="sec-title">Notification Preferences</div>
      <div class="notif-prefs">
        <div class="tog-row"><div><div class="tog-lbl">In-App Alerts</div><div class="tog-sub">Show toast pop-ups for new signals</div></div><label class="toggle"><input type="checkbox" id="nInApp" checked><span class="tog-slider"></span></label></div>
        <div class="tog-row"><div><div class="tog-lbl">Sound Alert</div><div class="tog-sub">Play a tone when signal is generated</div></div><label class="toggle"><input type="checkbox" id="nSound"><span class="tog-slider"></span></label></div>
        <div class="tog-row"><div><div class="tog-lbl">High Confidence Only (>90%)</div><div class="tog-sub">Only notify for very strong setups</div></div><label class="toggle"><input type="checkbox" id="nHighConf"><span class="tog-slider"></span></label></div>
        <div class="tog-row"><div><div class="tog-lbl">Crypto Signals</div><div class="tog-sub">Receive alerts for crypto trades</div></div><label class="toggle"><input type="checkbox" id="nCrypto" checked><span class="tog-slider"></span></label></div>
        <div class="tog-row"><div><div class="tog-lbl">Forex Signals</div><div class="tog-sub">Receive alerts for forex trades</div></div><label class="toggle"><input type="checkbox" id="nForex" checked><span class="tog-slider"></span></label></div>
        <div class="tog-row"><div><div class="tog-lbl">Expiry Warnings</div><div class="tog-sub">Alert when a trade is about to expire</div></div><label class="toggle"><input type="checkbox" id="nExpiry" checked><span class="tog-slider"></span></label></div>
      </div>
      <div class="sec-title">Alert Log</div>
      <div id="alertLogWrap" style="display:flex;flex-direction:column;gap:10px">
        <div style="color:var(--muted);font-size:.85rem">No alerts yet.</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEPLOY GUIDE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-deploy">
    <div class="panel">
      <div class="sec-title">ðŸš€ GitHub â†’ Google Cloud Run Setup</div>

      <div class="guide-box">
        <h3>Step 1 â€” Push to GitHub</h3>
        <ol>
          <li>Create a new repository on <strong>github.com</strong> (e.g. <code>apextrade-bot</code>)</li>
          <li>Download all project files and place them in a folder:<br>
            <code>app.py</code> &nbsp;Â·&nbsp; <code>static/index.html</code> &nbsp;Â·&nbsp; <code>requirements.txt</code> &nbsp;Â·&nbsp; <code>Dockerfile</code></li>
          <li>Open a terminal in that folder and run:<br>
            <code>git init</code><br>
            <code>git add .</code><br>
            <code>git commit -m "Initial commit"</code><br>
            <code>git branch -M main</code><br>
            <code>git remote add origin https://github.com/YOUR_USERNAME/apextrade-bot.git</code><br>
            <code>git push -u origin main</code>
          </li>
        </ol>
      </div>

      <div class="guide-box">
        <h3>Step 2 â€” Deploy to Google Cloud Run</h3>
        <ol>
          <li>Go to <strong>console.cloud.google.com</strong> â†’ Cloud Run â†’ <strong>Create Service</strong></li>
          <li>Choose <strong>"Continuously deploy from a repository"</strong> and connect your GitHub repo</li>
          <li>Set <strong>Branch</strong> to <code>main</code>, <strong>Build type</strong> to <code>Dockerfile</code></li>
          <li>Set <strong>Port</strong> to <code>8080</code>, allow <strong>unauthenticated invocations</strong></li>
          <li>Click <strong>Create</strong> â€” Cloud Run will build and deploy automatically</li>
        </ol>
      </div>

      <div class="guide-box">
        <h3>Step 3 â€” Add API Keys as Environment Variables</h3>
        <ol>
          <li>In Cloud Run â†’ your service â†’ <strong>Edit &amp; Deploy New Revision</strong></li>
          <li>Go to <strong>Variables &amp; Secrets</strong> tab and add:</li>
          <li><code>FINNHUB_KEY</code> â†’ your Finnhub API key (free at finnhub.io)</li>
          <li><code>TWELVE_DATA_KEY</code> â†’ your TwelveData key (free at twelvedata.com)</li>
          <li><code>ALPHA_VANTAGE_KEY</code> â†’ your Alpha Vantage key (free at alphavantage.co)</li>
          <li><code>CMC_KEY</code> â†’ CoinMarketCap key (paid, optional)</li>
          <li>Click <strong>Deploy</strong> â€” the bot will now use live prices</li>
        </ol>
      </div>

      <div class="guide-box">
        <h3>Step 4 â€” Future Updates</h3>
        <ol>
          <li>Any time you edit files locally, just run:<br>
            <code>git add .</code><br>
            <code>git commit -m "Update"</code><br>
            <code>git push</code>
          </li>
          <li>Cloud Run will automatically detect the push and redeploy. No manual steps needed!</li>
        </ol>
      </div>

      <div style="background:rgba(0,229,160,.06);border:1px solid rgba(0,229,160,.2);border-radius:12px;padding:16px;margin-top:4px">
        <div style="font-size:.78rem;color:var(--accent);font-weight:700;margin-bottom:6px">âœ… Note â€” CoinCap is Free (No Key Required)</div>
        <div style="font-size:.8rem;color:var(--muted);line-height:1.7">
          The bot uses CoinCap.io as its primary price source â€” it requires no API key and works immediately.
          Even if all other APIs are missing, the bot will always return trades using smart fallback estimated prices.
          Your signals will never say "no trade found."
        </div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<!-- TOAST PANEL -->
<div class="toast-panel" id="toastPanel"></div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {market:'crypto', type:'scalp', durMode:'auto', trades:[], timers:{}};

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme(){
  const h = document.documentElement;
  h.setAttribute('data-theme', h.getAttribute('data-theme')==='dark'?'light':'dark');
}

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SESSION_NAMES = {TOKYO:'Tokyo Session',LONDON_OPEN:'London Open',
  LONDON:'London Session',NEW_YORK:'New York Session',OVERLAP:'NY/London Overlap'};
function tick(){
  const now = new Date();
  document.getElementById('utcClock').textContent = now.toISOString().slice(11,19)+' UTC';
  const h = now.getUTCHours();
  let s;
  if(h>=22||h<7) s='TOKYO';
  else if(h<9)   s='LONDON_OPEN';
  else if(h<13)  s='LONDON';
  else if(h<17)  s='NEW_YORK';
  else            s='OVERLAP';
  document.getElementById('sessionBadge').textContent = SESSION_NAMES[s]||s;
}
setInterval(tick,1000); tick();

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name){
  const names=['signals','heatmap','history','alerts','deploy'];
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',names[i]===name));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='heatmap') loadHeatmap();
  if(name==='history') renderHistory();
  if(name==='alerts')  renderAlertLog();
}

// â”€â”€ CONTROL SEGMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSeg(grpId, el, val){
  document.getElementById(grpId).querySelectorAll('.seg').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  if(grpId==='grpMarket') state.market = val;
  if(grpId==='grpType')   state.type   = val;
}
function setDurMode(mode, el){
  state.durMode = mode;
  document.getElementById('grpDur').querySelectorAll('.seg').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('customDurWrap').style.display = mode==='custom'?'flex':'none';
}

// â”€â”€ PRICE FORMATTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(p, market){
  if(!p && p!==0) return 'â€”';
  if(market==='CRYPTO'||market==='crypto'){
    if(p>=10000) return '$'+p.toLocaleString('en-US',{maximumFractionDigits:0});
    if(p>=1000)  return '$'+p.toLocaleString('en-US',{maximumFractionDigits:1});
    if(p>=1)     return '$'+p.toFixed(4);
    if(p>=0.01)  return '$'+p.toFixed(5);
    return '$'+p.toFixed(8);
  }
  return p.toFixed(5);
}
function fmtSmall(p){
  if(!p&&p!==0) return 'â€”';
  if(p>=1000) return p.toLocaleString('en-US',{maximumFractionDigits:0});
  if(p>=1)    return p.toFixed(3);
  if(p>=0.01) return p.toFixed(5);
  return p.toFixed(8);
}

// â”€â”€ GENERATE TRADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateTrades(){
  const btn = document.getElementById('genBtn');
  btn.classList.add('busy');
  btn.innerHTML = '<span class="spin"></span>Scanning 6 Assetsâ€¦';

  let duration = null;
  if(state.durMode==='custom'){
    const v = parseInt(document.getElementById('durInput').value);
    if(v && v>0) duration = v;
  }

  try{
    const res = await fetch('/api/generate_trade',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({market:state.market, trade_type:state.type, duration})
    });
    const top3 = await res.json();
    if(!Array.isArray(top3)||!top3.length){ toast('No data returned. Retry.','warn'); return; }

    // Add to session list
    top3.forEach(t=>{ state.trades.unshift(t); });

    // Render
    renderTop3(top3);
    updateStats();
    // Notify for #1 trade
    doNotify(top3[0]);
    top3.forEach(t=>addAlert(t));

    // Start timers
    top3.forEach(t=>startTimer(t));

  } catch(e){
    toast('Network error â€” check your connection.','warn');
    console.error(e);
  } finally{
    btn.classList.remove('busy');
    btn.innerHTML = 'âš¡ Generate Top 3 Trades';
  }
}

// â”€â”€ RENDER TOP 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MEDALS = {1:'ðŸ¥‡',2:'ðŸ¥ˆ',3:'ðŸ¥‰'};
const RANK_LABELS = {1:'#1 Highest Probability',2:'#2 High Probability',3:'#3 Solid Setup'};

function renderTop3(trades){
  const area = document.getElementById('tradeArea');
  // remove placeholder
  const ph = area.querySelector('.placeholder');
  if(ph) ph.remove();

  // Remove previous top3 group
  const old = area.querySelector('.top3-group');
  if(old) old.remove();

  const group = document.createElement('div');
  group.className = 'top3-group';
  group.innerHTML = `<div class="top3-label">Latest Scan â€” Top 3 Signals by Confidence</div>
    <div class="top3-grid">${trades.map(t=>buildCard(t)).join('')}</div>`;
  area.insertBefore(group, area.firstChild);

  // Keep max 3 previous groups
  const groups = area.querySelectorAll('.top3-group');
  if(groups.length > 3) groups[groups.length-1].remove();
}

function buildCard(t){
  const isLong = t.direction==='LONG';
  const dirCls = isLong?'LONG':'SHORT';
  const dirBdg = isLong?'b-long':'b-short';
  const inds = Object.entries(t.indicators||{}).map(([name,d])=>`
    <div class="ind-row">
      <div class="ind-dot"></div>
      <div class="ind-info">
        <div class="ind-name">${name}</div>
        <div class="ind-sig">${d.signal}</div>
      </div>
      <div class="ind-val">${d.value}</div>
    </div>`).join('');

  const volC = {EXTREME:'#ff3d71',HIGH:'var(--warn)',NORMAL:'var(--primary)',LOW:'var(--accent)'}[t.volatility?.level]||'var(--primary)';

  return `
  <div class="rank-card r${t.rank} ${dirCls}" id="tc-${t.id}">
    <div class="medal">${MEDALS[t.rank]}</div>

    <div class="card-hdr">
      <div>
        <div style="font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-weight:700">${RANK_LABELS[t.rank]}</div>
        <div class="asset-name">${t.asset}</div>
        <div class="asset-sub">${t.market} Â· ${t.trade_type} Â· ${t.session?.replace(/_/g,' ')}</div>
        <div class="badges" style="margin-top:8px">
          <span class="badge ${dirBdg}">${t.direction}</span>
          <span class="badge b-info">${t.timeframe}</span>
          <span class="badge b-safe">NEWS: ${t.news_status}</span>
          <span class="badge b-info">SRC: ${t.price_source}</span>
          ${t.price_source==='estimated'?'<span class="badge b-warn">EST PRICE</span>':''}
        </div>
      </div>
    </div>

    <div class="metrics">
      <div class="metric"><div class="m-lbl">Entry Price</div><div class="m-val pri">${fmt(t.entry,t.market)}</div><div class="m-sub">Live market price</div></div>
      <div class="metric"><div class="m-lbl">Take Profit</div><div class="m-val buy">${fmt(t.tp,t.market)}</div><div class="m-sub">+${t.tp_pct}%</div></div>
      <div class="metric"><div class="m-lbl">Stop Loss</div><div class="m-val sell">${fmt(t.sl,t.market)}</div><div class="m-sub">âˆ’${t.sl_pct}% ATR buffered</div></div>
      <div class="metric"><div class="m-lbl">Leverage</div><div class="m-val pri">${t.leverage}x</div><div class="m-sub">Dynamic</div></div>
      <div class="metric"><div class="m-lbl">Risk:Reward</div><div class="m-val ${t.rr>=2?'buy':'pri'}">1:${t.rr}</div><div class="m-sub">Min 1:1.8</div></div>
      <div class="metric"><div class="m-lbl">Duration</div><div class="m-val pri">${t.duration}</div><div class="m-sub">Auto-close target</div></div>
      <div class="metric"><div class="m-lbl">Volatility</div><div class="m-val" style="color:${volC}">${t.volatility?.level||'â€”'}</div><div class="m-sub">${t.volatility?.speed||''} mkt</div></div>
      <div class="metric"><div class="m-lbl">24h Change</div><div class="m-val ${t.change24h>=0?'buy':'sell'}">${t.change24h>=0?'+':''}${t.change24h}%</div><div class="m-sub">Price momentum</div></div>
    </div>

    <div class="conf-wrap">
      <div class="conf-top">
        <span class="conf-lbl">Signal Confidence (${t.indicators_passed}/${t.indicators_total} Indicators)</span>
        <span class="conf-pct">${t.confidence}%</span>
      </div>
      <div class="conf-bar"><div class="conf-fill" style="width:${t.confidence}%"></div></div>
    </div>

    <div style="margin-top:14px">
      <div class="sec-title" style="font-size:.68rem;margin-bottom:9px">Indicator Confluence</div>
      <div class="ind-grid">${inds}</div>
    </div>

    <div class="reason">
      <h4>ðŸ“Š Trade Analysis</h4>
      <p>${t.reasoning}</p>
    </div>

    <div class="timer-sec" id="tmr-${t.id}">
      <div class="timer-lbl">Time Remaining</div>
      <div class="timer-disp" id="td-${t.id}">--:--:--</div>
      <div class="timer-bar"><div class="timer-fill" id="tf-${t.id}" style="width:100%"></div></div>
    </div>

    <button class="close-btn" onclick="closeOne(${t.id})">âœ• Close Trade</button>
  </div>`;
}

// â”€â”€ TIMERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer(t){
  if(!t.duration_min) return;
  const end   = Date.now() + t.duration_min * 60000;
  const total = t.duration_min * 60000;
  const id    = setInterval(()=>{
    const left = end - Date.now();
    const disp = document.getElementById(`td-${t.id}`);
    const bar  = document.getElementById(`tf-${t.id}`);
    if(!disp){ clearInterval(id); return; }
    if(left<=0){
      disp.textContent='00:00:00';
      if(bar) bar.style.width='0%';
      clearInterval(id);
      autoClose(t.id, t.asset);
      return;
    }
    if(left < total*0.2 && document.getElementById('nExpiry')?.checked && !state.timers[`w${t.id}`]){
      state.timers[`w${t.id}`]=true;
      toast(`âš ï¸ ${t.asset} trade expiring soon!`,'warn');
    }
    const h=Math.floor(left/3600000), m=Math.floor((left%3600000)/60000), s=Math.floor((left%60000)/1000);
    disp.textContent=[h,m,s].map(n=>String(n).padStart(2,'0')).join(':');
    if(bar) bar.style.width=(left/total*100)+'%';
  },1000);
  state.timers[t.id]=id;
}

function autoClose(id, asset){
  const card = document.getElementById(`tc-${id}`);
  if(card){
    const ts = document.getElementById(`tmr-${id}`);
    if(ts) ts.innerHTML='<div style="color:var(--accent);font-weight:700;font-size:.85rem">âœ… Duration reached â€” trade closed</div>';
    card.style.opacity='0.6';
  }
  state.trades = state.trades.map(t=>t.id===id?{...t,status:'CLOSED'}:t);
  updateStats();
  toast(`${asset} auto-closed at target duration âœ…`,'buy');
}

async function closeOne(id){
  clearInterval(state.timers[id]);
  const card = document.getElementById(`tc-${id}`);
  if(card){ card.style.opacity='0.45'; card.style.pointerEvents='none'; }
  try{ await fetch('/api/close_trade',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); }catch(e){}
  state.trades = state.trades.map(t=>t.id===id?{...t,status:'CLOSED'}:t);
  updateStats();
}

// â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats(){
  const open  = state.trades.filter(t=>t.status==='OPEN').length;
  const confs = state.trades.map(t=>t.confidence).filter(Boolean);
  const levs  = state.trades.map(t=>t.leverage).filter(Boolean);
  const rrs   = state.trades.map(t=>t.rr).filter(Boolean);
  document.getElementById('sTot').textContent  = state.trades.length;
  document.getElementById('sOpen').textContent = open;
  document.getElementById('sConf').textContent = confs.length?(confs.reduce((a,b)=>a+b,0)/confs.length).toFixed(1)+'%':'â€”';
  document.getElementById('sLev').textContent  = levs.length ?Math.round(levs.reduce((a,b)=>a+b,0)/levs.length)+'x':'â€”';
  document.getElementById('sRR').textContent   = rrs.length  ?'1:'+Math.max(...rrs).toFixed(2):'â€”';
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistory(){
  const tbody = document.getElementById('histBody');
  if(!state.trades.length){
    tbody.innerHTML='<tr><td colspan="12" style="text-align:center;padding:40px;color:var(--muted)">No signals yet.</td></tr>';
    return;
  }
  tbody.innerHTML = state.trades.slice(0,60).map(t=>`
    <tr>
      <td><span class="rank-badge r${t.rank||1}">${t.rank||'â€”'}</span></td>
      <td><strong>${t.asset}</strong></td>
      <td>${t.trade_type}</td>
      <td style="color:${t.direction==='LONG'?'var(--buy)':'var(--sell)'};font-weight:700">${t.direction}</td>
      <td style="font-family:'Space Mono',monospace;font-size:.76rem">${fmt(t.entry,t.market)}</td>
      <td style="color:var(--buy)">${fmt(t.tp,t.market)}</td>
      <td style="color:var(--sell)">${fmt(t.sl,t.market)}</td>
      <td style="color:${t.rr>=2?'var(--buy)':'var(--primary)'};font-weight:700">1:${t.rr}</td>
      <td>${t.leverage}x</td>
      <td>${t.duration}</td>
      <td style="color:var(--accent);font-weight:700">${t.confidence}%</td>
      <td style="color:${t.status==='OPEN'?'var(--accent)':'var(--muted)'};font-weight:600">${t.status}</td>
    </tr>`).join('');
}

// â”€â”€ HEATMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHeatmap(){
  const g = document.getElementById('heatmapGrid');
  g.innerHTML='<div style="color:var(--muted);padding:20px;font-size:.85rem">Loadingâ€¦</div>';
  try{
    const res = await fetch('/api/heatmap');
    const data = await res.json();
    g.innerHTML = data.map(a=>{
      const c=a.change;
      const bg = c>8?'#00280f':c>4?'#001e0a':c>2?'#001505':c>0?'#000d02':
                 c<-8?'#280003':c<-4?'#1e0002':c<-2?'#150001':'#0a0001';
      const tc = c>=0?'#00e5a0':'#ff3d71';
      return `<div class="heat-cell" style="background:${bg}">
        <div class="heat-sym">${a.symbol}</div>
        <div class="heat-chg" style="color:${tc}">${c>=0?'+':''}${c.toFixed(2)}%</div>
        <div class="heat-px">$${fmtSmall(a.price)}</div>
      </div>`;
    }).join('');
  }catch(e){
    g.innerHTML='<div style="color:var(--muted);padding:20px">Failed to load heatmap.</div>';
  }
}

// â”€â”€ TICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTicker(){
  try{
    const res=await fetch('/api/heatmap');
    const data=await res.json();
    const items=data.slice(0,18).map(a=>{
      const cl=a.change>=0?'up':'dn';
      return `<span class="tick-item"><span class="tick-sym">${a.symbol}</span><span class="tick-px">$${fmtSmall(a.price)}</span><span class="tick-ch ${cl}">${a.change>=0?'+':''}${a.change.toFixed(2)}%</span></span>`;
    });
    document.getElementById('tickerInner').innerHTML=[...items,...items].join('');
  }catch(e){}
}
loadTicker(); setInterval(loadTicker,30000);

// â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doNotify(t){
  if(!document.getElementById('nInApp')?.checked) return;
  const highOnly = document.getElementById('nHighConf')?.checked;
  if(highOnly && t.confidence<90) return;
  const mktKey = t.market==='CRYPTO'?'nCrypto':'nForex';
  if(!document.getElementById(mktKey)?.checked) return;
  const ico = t.direction==='LONG'?'ðŸŸ¢':'ðŸ”´';
  toast(`${ico} ${t.asset} ${t.direction} â€” ${t.confidence}% confidence\nEntry: ${fmt(t.entry,t.market)} | TP: ${fmt(t.tp,t.market)} | SL: ${fmt(t.sl,t.market)}\n${t.leverage}x leverage Â· ${t.duration}`, t.direction==='LONG'?'buy':'sell');
  if(document.getElementById('nSound')?.checked){
    try{
      const ctx=new AudioContext();
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = t.direction==='LONG'?880:440;
      o.type='sine';
      g.gain.setValueAtTime(0.25,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.5);
      o.start(); o.stop(ctx.currentTime+0.5);
    }catch(e){}
  }
}

function toast(msg, type='info'){
  const panel=document.getElementById('toastPanel');
  const d=document.createElement('div');
  d.className=`toast ${type==='sell'?'sell':type==='warn'?'warn':''}`;
  d.innerHTML=`<div class="toast-hdr"><div class="toast-title">âš¡ APEX TRADE</div><div class="toast-x" onclick="this.closest('.toast').remove()">âœ•</div></div><div class="toast-body">${msg}</div>`;
  panel.appendChild(d);
  setTimeout(()=>d.remove(), 9000);
}

const alertLog=[];
function addAlert(t){
  alertLog.unshift({time:new Date().toLocaleTimeString(),asset:t.asset,dir:t.direction,conf:t.confidence,entry:fmt(t.entry,t.market),rank:t.rank});
}
function renderAlertLog(){
  const w=document.getElementById('alertLogWrap');
  if(!alertLog.length){ w.innerHTML='<div style="color:var(--muted);font-size:.85rem">No alerts yet.</div>'; return; }
  w.innerHTML=alertLog.slice(0,25).map(a=>`
    <div class="toast" style="animation:none">
      <div class="toast-hdr">
        <div class="toast-title">${MEDALS[a.rank]||''} ${a.asset} â€” ${a.dir}</div>
        <div style="font-size:.68rem;color:var(--muted)">${a.time}</div>
      </div>
      <div class="toast-body">Entry: ${a.entry} Â· Confidence: ${a.conf}%</div>
    </div>`).join('');
}
</script>
</body>
</html>
